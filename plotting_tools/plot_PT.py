import numpy as np
import matplotlib.pyplot as pl
import seaborn as sns
from math import exp

P_surf = 1e6
T_surf = 1225.0

L=2493000        # J/kg, latent heat of condensation of water vapor at 300K
k = 1.38065812e-23
N_avogadro = 6.022136736e+23
Rstar = 1000.*k*N_avogadro
H2O_MolecularWeight = 18.0
R = Rstar/H2O_MolecularWeight # J/kg, specific gas constant of water vapor

H2O_TriplePointT = 2.731500e+02
H2O_TriplePointP = 6.110000e+02
Tref = 350.0

def satvps(T,T0,e0,MolecularWeight,LatentHeat):
  Rv=Rstar/MolecularWeight
  return e0*exp(-(LatentHeat/Rv)*(1./T - 1./T0))

def Tdew(p): # Vapor-Liquid equilibrium temperature of water at pressure p<ps. Assumes ideal gas, T<<Tc and constant L.
    pref = satvps(Tref,H2O_TriplePointT,H2O_TriplePointP,H2O_MolecularWeight,L)
    return Tref/(1-(R*Tref/L)*np.log(p/pref)) # assumes a pure steam atmosphere

data_output = f'/network/group/aopp/planetary/RTP028_BOUKROUCHE_RUNAWAY2/soc-rad-conv/data_{int(P_surf)}_{int(T_surf)}.dat'

p_soc = np.loadtxt(data_output,usecols=0)
T_soc = np.loadtxt(data_output,usecols=1)
dew_point = np.zeros(len(T_soc))
for i in range(len(T_soc)):
    dew_point[i] = Tdew(p_soc[i])
direct_up = np.loadtxt(data_output,usecols=2)
diffuse_up = np.loadtxt(data_output,usecols=3)
direct_down = np.loadtxt(data_output,usecols=4)
diffuse_down = np.loadtxt(data_output,usecols=5)
direct_net = np.loadtxt(data_output,usecols=6)
diffuse_net = np.loadtxt(data_output,usecols=7)
total_up = np.loadtxt(data_output,usecols=8)
total_down = np.loadtxt(data_output,usecols=9)
total_net = np.loadtxt(data_output,usecols=10)

data_output_dT = f'/network/group/aopp/planetary/RTP028_BOUKROUCHE_RUNAWAY2/soc-rad-conv/data_heating_{int(P_surf)}_{int(T_surf)}.dat'
dTSW = np.loadtxt(data_output_dT,usecols=0)
dTLW = np.loadtxt(data_output_dT,usecols=1)
dTnet = np.loadtxt(data_output_dT,usecols=2)

data_output_spectral_TOA = f'/network/group/aopp/planetary/RTP028_BOUKROUCHE_RUNAWAY2/soc-rad-conv/data_spectral_TOA_{int(P_surf)}_{int(T_surf)}.dat'
diffuse_spectral_up_TOA = np.loadtxt(data_output_spectral_TOA,usecols=0)
direct_spectral_up_TOA = np.loadtxt(data_output_spectral_TOA,usecols=1)
net_spectral_TOA = np.loadtxt(data_output_spectral_TOA,usecols=2)

data_output_spectral_surf = f'/network/group/aopp/planetary/RTP028_BOUKROUCHE_RUNAWAY2/soc-rad-conv/data_spectral_Surface_{int(P_surf)}_{int(T_surf)}.dat'
diffuse_spectral_up_surf = np.loadtxt(data_output_spectral_surf,usecols=0)
direct_spectral_up_surf = np.loadtxt(data_output_spectral_surf,usecols=1)
net_spectral_surf = np.loadtxt(data_output_spectral_surf,usecols=2)

Bands_soc = np.array([[4.000000000E-04,     1.000000000E-02],
                      [2.000000000E-04,     4.000000000E-04],
                      [1.333333333E-04,     2.000000000E-04],
                      [1.000000000E-04,     1.333333333E-04],
                      [8.000000000E-05,     1.000000000E-04],
                      [6.666666667E-05,     8.000000000E-05],
                      [5.714285714E-05,     6.666666667E-05],
                      [5.000000000E-05,     5.714285714E-05],
                      [4.444444444E-05,     5.000000000E-05],
                      [4.000000000E-05,     4.444444444E-05],   
                      [3.636363636E-05,     4.000000000E-05],
                      [3.333333333E-05,     3.636363636E-05],
                      [3.076923077E-05,     3.333333333E-05],
                      [2.857142857E-05,     3.076923077E-05],
                      [2.666666667E-05,     2.857142857E-05],
                      [2.500000000E-05,     2.666666667E-05],
                      [2.352941176E-05,     2.500000000E-05],
                      [2.222222222E-05,     2.352941176E-05],
                      [2.105263158E-05,     2.222222222E-05],
                      [2.000000000E-05,     2.105263158E-05],
                      [1.904761905E-05,     2.000000000E-05],
                      [1.818181818E-05,     1.904761905E-05],
                      [1.739130435E-05,     1.818181818E-05],
                      [1.666666667E-05,     1.739130435E-05],
                      [1.600000000E-05,     1.666666667E-05],
                      [1.538461538E-05,     1.600000000E-05],
                      [1.481481481E-05,     1.538461538E-05],
                      [1.428571429E-05,     1.481481481E-05],
                      [1.379310345E-05,     1.428571429E-05],
                      [1.333333333E-05,     1.379310345E-05],
                      [1.290322581E-05,     1.333333333E-05],
                      [1.250000000E-05,     1.290322581E-05],
                      [1.212121212E-05,     1.250000000E-05],
                      [1.176470588E-05,     1.212121212E-05],
                      [1.142857143E-05,     1.176470588E-05],
                      [1.111111111E-05,     1.142857143E-05],
                      [1.081081081E-05,     1.111111111E-05],
                      [1.052631579E-05,     1.081081081E-05],
                      [1.025641026E-05,     1.052631579E-05],
                      [1.000000000E-05,     1.025641026E-05],
                      [9.756097561E-06,     1.000000000E-05],
                      [9.523809524E-06,     9.756097561E-06],
                      [9.302325581E-06,     9.523809524E-06],
                      [9.090909091E-06,     9.302325581E-06],
                      [8.888888889E-06,     9.090909091E-06],
                      [8.695652174E-06,     8.888888889E-06],
                      [8.510638298E-06,     8.695652174E-06],
                      [8.333333333E-06,     8.510638298E-06],
                      [8.163265306E-06,     8.333333333E-06],
                      [8.000000000E-06,     8.163265306E-06],
                      [7.843137255E-06,     8.000000000E-06],
                      [7.692307692E-06,     7.843137255E-06],
                      [7.547169811E-06,     7.692307692E-06],
                      [7.407407407E-06,     7.547169811E-06],
                      [7.272727273E-06,     7.407407407E-06],
                      [7.142857143E-06,     7.272727273E-06],
                      [7.017543860E-06,     7.142857143E-06],
                      [6.896551724E-06,     7.017543860E-06],
                      [6.779661017E-06,     6.896551724E-06],
                      [6.666666667E-06,     6.779661017E-06],
                      [6.557377049E-06,     6.666666667E-06],
                      [6.451612903E-06,     6.557377049E-06],
                      [6.349206349E-06,     6.451612903E-06],
                      [6.250000000E-06,     6.349206349E-06],
                      [6.153846154E-06,     6.250000000E-06],
                      [6.060606061E-06,     6.153846154E-06],
                      [5.970149254E-06,     6.060606061E-06],
                      [5.882352941E-06,     5.970149254E-06],
                      [5.797101449E-06,     5.882352941E-06],
                      [5.714285714E-06,     5.797101449E-06],
                      [5.633802817E-06,     5.714285714E-06],
                      [5.555555556E-06,     5.633802817E-06],
                      [5.479452055E-06,     5.555555556E-06],
                      [5.405405405E-06,     5.479452055E-06],
                      [5.333333333E-06,     5.405405405E-06],
                      [5.263157895E-06,     5.333333333E-06],
                      [5.194805195E-06,     5.263157895E-06],
                      [5.128205128E-06,     5.194805195E-06],
                      [5.063291139E-06,     5.128205128E-06],
                      [5.000000000E-06,     5.063291139E-06],
                      [4.938271605E-06,     5.000000000E-06],
                      [4.878048780E-06,     4.938271605E-06],
                      [4.819277108E-06,     4.878048780E-06],
                      [4.761904762E-06,     4.819277108E-06],
                      [4.705882353E-06,     4.761904762E-06],
                      [4.651162791E-06,     4.705882353E-06],
                      [4.597701149E-06,     4.651162791E-06],
                      [4.545454545E-06,     4.597701149E-06],
                      [4.494382022E-06,     4.545454545E-06],
                      [4.444444444E-06,     4.494382022E-06],
                      [4.395604396E-06,     4.444444444E-06],
                      [4.347826087E-06,     4.395604396E-06],
                      [4.301075269E-06,     4.347826087E-06],
                      [4.255319149E-06,     4.301075269E-06],
                      [4.210526316E-06,     4.255319149E-06],
                      [4.166666667E-06,     4.210526316E-06],
                      [4.123711340E-06,     4.166666667E-06],
                      [4.081632653E-06,     4.123711340E-06],
                      [4.040404040E-06,     4.081632653E-06],
                      [4.000000000E-06,     4.040404040E-06],
                      [3.960396040E-06,     4.000000000E-06],
                      [3.921568627E-06,     3.960396040E-06],
                      [3.883495146E-06,     3.921568627E-06],
                      [3.846153846E-06,     3.883495146E-06],
                      [3.809523810E-06,     3.846153846E-06],
                      [3.773584906E-06,     3.809523810E-06],
                      [3.738317757E-06,     3.773584906E-06],
                      [3.703703704E-06,     3.738317757E-06],
                      [3.669724771E-06,     3.703703704E-06],
                      [3.636363636E-06,     3.669724771E-06],
                      [3.603603604E-06,     3.636363636E-06],
                      [3.571428571E-06,     3.603603604E-06],
                      [3.539823009E-06,     3.571428571E-06],
                      [3.508771930E-06,     3.539823009E-06],
                      [3.478260870E-06,     3.508771930E-06],
                      [3.448275862E-06,     3.478260870E-06],
                      [3.418803419E-06,     3.448275862E-06],
                      [3.389830508E-06,     3.418803419E-06],
                      [3.361344538E-06,     3.389830508E-06],
                      [3.333333333E-06,     3.361344538E-06],
                      [3.278688525E-06,     3.333333333E-06],
                      [3.225806452E-06,     3.278688525E-06],
                      [3.174603175E-06,     3.225806452E-06],
                      [3.125000000E-06,     3.174603175E-06],
                      [3.076923077E-06,     3.125000000E-06],
                      [3.030303030E-06,     3.076923077E-06],
                      [2.985074627E-06,     3.030303030E-06],
                      [2.941176471E-06,     2.985074627E-06],
                      [2.898550725E-06,     2.941176471E-06],
                      [2.857142857E-06,     2.898550725E-06],
                      [2.816901408E-06,     2.857142857E-06],
                      [2.777777778E-06,     2.816901408E-06],
                      [2.739726027E-06,     2.777777778E-06],
                      [2.702702703E-06,     2.739726027E-06],
                      [2.666666667E-06,     2.702702703E-06],
                      [2.631578947E-06,     2.666666667E-06],
                      [2.597402597E-06,     2.631578947E-06],
                      [2.564102564E-06,     2.597402597E-06],
                      [2.531645570E-06,     2.564102564E-06],
                      [2.500000000E-06,     2.531645570E-06],
                      [2.469135802E-06,     2.500000000E-06],
                      [2.439024390E-06,     2.469135802E-06],
                      [2.409638554E-06,     2.439024390E-06],
                      [2.380952381E-06,     2.409638554E-06],
                      [2.352941176E-06,     2.380952381E-06],
                      [2.325581395E-06,     2.352941176E-06],
                      [2.298850575E-06,     2.325581395E-06],
                      [2.272727273E-06,     2.298850575E-06],
                      [2.247191011E-06,     2.272727273E-06],
                      [2.222222222E-06,     2.247191011E-06],
                      [2.197802198E-06,     2.222222222E-06],
                      [2.173913043E-06,     2.197802198E-06],
                      [2.150537634E-06,     2.173913043E-06],
                      [2.127659574E-06,     2.150537634E-06],
                      [2.105263158E-06,     2.127659574E-06],
                      [2.083333333E-06,     2.105263158E-06],
                      [2.061855670E-06,     2.083333333E-06],
                      [2.040816327E-06,     2.061855670E-06],
                      [2.020202020E-06,     2.040816327E-06],
                      [2.000000000E-06,     2.020202020E-06],
                      [1.980198020E-06,     2.000000000E-06],
                      [1.960784314E-06,     1.980198020E-06],
                      [1.941747573E-06,     1.960784314E-06],
                      [1.923076923E-06,     1.941747573E-06],
                      [1.904761905E-06,     1.923076923E-06],
                      [1.886792453E-06,     1.904761905E-06],
                      [1.869158879E-06,     1.886792453E-06],
                      [1.851851852E-06,     1.869158879E-06],
                      [1.834862385E-06,     1.851851852E-06],
                      [1.818181818E-06,     1.834862385E-06],
                      [1.801801802E-06,     1.818181818E-06],
                      [1.785714286E-06,     1.801801802E-06],
                      [1.769911504E-06,     1.785714286E-06],
                      [1.754385965E-06,     1.769911504E-06],
                      [1.739130435E-06,     1.754385965E-06],
                      [1.724137931E-06,     1.739130435E-06],
                      [1.709401709E-06,     1.724137931E-06],
                      [1.694915254E-06,     1.709401709E-06],
                      [1.680672269E-06,     1.694915254E-06],
                      [1.666666667E-06,     1.680672269E-06],
                      [1.652892562E-06,     1.666666667E-06],
                      [1.639344262E-06,     1.652892562E-06],
                      [1.626016260E-06,     1.639344262E-06],
                      [1.612903226E-06,     1.626016260E-06],
                      [1.600000000E-06,     1.612903226E-06],
                      [1.587301587E-06,     1.600000000E-06],
                      [1.574803150E-06,     1.587301587E-06],
                      [1.562500000E-06,     1.574803150E-06],
                      [1.550387597E-06,     1.562500000E-06],
                      [1.538461538E-06,     1.550387597E-06],
                      [1.526717557E-06,     1.538461538E-06],
                      [1.515151515E-06,     1.526717557E-06],
                      [1.503759398E-06,     1.515151515E-06],
                      [1.492537313E-06,     1.503759398E-06],
                      [1.481481481E-06,     1.492537313E-06],
                      [1.470588235E-06,     1.481481481E-06],
                      [1.459854015E-06,     1.470588235E-06],
                      [1.449275362E-06,     1.459854015E-06],
                      [1.438848921E-06,     1.449275362E-06],
                      [1.428571429E-06,     1.438848921E-06],
                      [1.418439716E-06,     1.428571429E-06],
                      [1.408450704E-06,     1.418439716E-06],
                      [1.398601399E-06,     1.408450704E-06],
                      [1.388888889E-06,     1.398601399E-06],
                      [1.379310345E-06,     1.388888889E-06],
                      [1.369863014E-06,     1.379310345E-06],
                      [1.360544218E-06,     1.369863014E-06],
                      [1.351351351E-06,     1.360544218E-06],
                      [1.342281879E-06,     1.351351351E-06],
                      [1.333333333E-06,     1.342281879E-06],
                      [1.324503311E-06,     1.333333333E-06],
                      [1.315789474E-06,     1.324503311E-06],
                      [1.307189542E-06,     1.315789474E-06],
                      [1.298701299E-06,     1.307189542E-06],
                      [1.290322581E-06,     1.298701299E-06],
                      [1.282051282E-06,     1.290322581E-06],
                      [1.273885350E-06,     1.282051282E-06],
                      [1.265822785E-06,     1.273885350E-06],
                      [1.257861635E-06,     1.265822785E-06],
                      [1.250000000E-06,     1.257861635E-06],
                      [1.242236025E-06,     1.250000000E-06],
                      [1.234567901E-06,     1.242236025E-06],
                      [1.226993865E-06,     1.234567901E-06],
                      [1.219512195E-06,     1.226993865E-06],
                      [1.212121212E-06,     1.219512195E-06],
                      [1.204819277E-06,     1.212121212E-06],
                      [1.197604790E-06,     1.204819277E-06],
                      [1.190476190E-06,     1.197604790E-06],
                      [1.183431953E-06,     1.190476190E-06],
                      [1.176470588E-06,     1.183431953E-06],
                      [1.169590643E-06,     1.176470588E-06],
                      [1.162790698E-06,     1.169590643E-06],
                      [1.156069364E-06,     1.162790698E-06],
                      [1.149425287E-06,     1.156069364E-06],
                      [1.142857143E-06,     1.149425287E-06],
                      [1.136363636E-06,     1.142857143E-06],
                      [1.129943503E-06,     1.136363636E-06],
                      [1.123595506E-06,     1.129943503E-06],
                      [1.117318436E-06,     1.123595506E-06],
                      [1.111111111E-06,     1.117318436E-06],
                      [1.104972376E-06,     1.111111111E-06],
                      [1.098901099E-06,     1.104972376E-06],
                      [1.092896175E-06,     1.098901099E-06],
                      [1.086956522E-06,     1.092896175E-06],
                      [1.081081081E-06,     1.086956522E-06],
                      [1.075268817E-06,     1.081081081E-06],
                      [1.069518717E-06,     1.075268817E-06],
                      [1.063829787E-06,     1.069518717E-06],
                      [1.058201058E-06,     1.063829787E-06],
                      [1.052631579E-06,     1.058201058E-06],
                      [1.047120419E-06,     1.052631579E-06],
                      [1.041666667E-06,     1.047120419E-06],
                      [1.036269430E-06,     1.041666667E-06],
                      [1.030927835E-06,     1.036269430E-06],
                      [1.025641026E-06,     1.030927835E-06],
                      [1.020408163E-06,     1.025641026E-06],
                      [1.015228426E-06,     1.020408163E-06],
                      [1.010101010E-06,     1.015228426E-06],
                      [1.005025126E-06,     1.010101010E-06],
                      [1.000000000E-06,     1.005025126E-06],
                      [9.950248756E-07,     1.000000000E-06],
                      [9.900990099E-07,     9.950248756E-07],
                      [9.852216749E-07,     9.900990099E-07],
                      [9.803921569E-07,     9.852216749E-07],
                      [9.756097561E-07,     9.803921569E-07],
                      [9.708737864E-07,     9.756097561E-07],
                      [9.661835749E-07,     9.708737864E-07],
                      [9.615384615E-07,     9.661835749E-07],
                      [9.569377990E-07,     9.615384615E-07],
                      [9.523809524E-07,     9.569377990E-07],
                      [9.478672986E-07,     9.523809524E-07],
                      [9.433962264E-07,     9.478672986E-07],
                      [9.389671362E-07,     9.433962264E-07],
                      [9.345794393E-07,     9.389671362E-07],
                      [9.302325581E-07,     9.345794393E-07],
                      [9.259259259E-07,     9.302325581E-07],
                      [9.216589862E-07,     9.259259259E-07],
                      [9.174311927E-07,     9.216589862E-07],
                      [9.132420091E-07,     9.174311927E-07],
                      [9.090909091E-07,     9.132420091E-07],
                      [8.695652174E-07,     9.090909091E-07],
                      [8.333333333E-07,     8.695652174E-07],
                      [8.000000000E-07,     8.333333333E-07],
                      [7.692307692E-07,     8.000000000E-07],
                      [7.407407407E-07,     7.692307692E-07],
                      [7.142857143E-07,     7.407407407E-07],
                      [6.896551724E-07,     7.142857143E-07],
                      [6.666666667E-07,     6.896551724E-07],
                      [6.451612903E-07,     6.666666667E-07],
                      [6.250000000E-07,     6.451612903E-07],
                      [6.060606061E-07,     6.250000000E-07],
                      [5.882352941E-07,     6.060606061E-07],
                      [5.714285714E-07,     5.882352941E-07],
                      [5.555555556E-07,     5.714285714E-07],
                      [5.405405405E-07,     5.555555556E-07],
                      [5.263157895E-07,     5.405405405E-07],
                      [5.128205128E-07,     5.263157895E-07],
                      [5.000000000E-07,     5.128205128E-07],
                      [4.878048780E-07,     5.000000000E-07],
                      [4.761904762E-07,     4.878048780E-07],
                      [4.651162791E-07,     4.761904762E-07],
                      [4.545454545E-07,     4.651162791E-07],
                      [4.444444444E-07,     4.545454545E-07],
                      [4.347826087E-07,     4.444444444E-07],
                      [4.255319149E-07,     4.347826087E-07],
                      [4.166666667E-07,     4.255319149E-07],
                      [4.081632653E-07,     4.166666667E-07],
                      [4.000000000E-07,     4.081632653E-07],
                      [3.921568627E-07,     4.000000000E-07],
                      [3.846153846E-07,     3.921568627E-07],
                      [3.773584906E-07,     3.846153846E-07],
                      [3.703703704E-07,     3.773584906E-07],
                      [3.636363636E-07,     3.703703704E-07],
                      [3.571428571E-07,     3.636363636E-07],
                      [3.508771930E-07,     3.571428571E-07],
                      [3.448275862E-07,     3.508771930E-07],
                      [3.389830508E-07,     3.448275862E-07],
                      [3.333333333E-07,     3.389830508E-07]])

Band_centers_soc = np.array([np.array([np.mean(Bands_soc[i,:])]) for i in range(len(Bands_soc[:,0]))])*1e6

fig, (ax1,ax2) = pl.subplots(1, 2, figsize=(13,6))
fig.subplots_adjust(wspace=0.05)
ax1.semilogy(T_soc,p_soc, label='Profile')
ax1.semilogy(dew_point,p_soc, linestyle='--', color='r', label='Dew point')
ax2.semilogy(diffuse_net,p_soc, label="Net diffuse flux")
ax2.semilogy(total_net,p_soc, label="Net flux")
ax1.invert_yaxis()
ax2.invert_yaxis()
ax1.set_xlabel(r'Temperature, $T$ [K]')
ax1.set_ylabel(r'Pressure, $P$ [Pa]')
ax2.set_xlabel(r'Flux, $F$ [W m$^{-2}$]')
ax1.legend(frameon=True,loc='best')
ax2.legend(frameon=True,loc='best')
sns.despine(fig=None, ax=None, top=True, right=True, left=False, bottom=False, offset=None, trim=False)
fig.savefig('PT_flux_SOCRATES.pdf',bbox_inches='tight')
pl.show()
#pl.close()


fig, ax = pl.subplots(figsize=(10,8))
ax.semilogx(Band_centers_soc,diffuse_spectral_up_TOA, label="Diffuse up", linewidth=0.5 ,zorder=10)
ax.semilogx(Band_centers_soc,direct_spectral_up_TOA, label="Direct up", linewidth=0.5 ,zorder=5)
ax.semilogx(Band_centers_soc,net_spectral_TOA, label="Total net", linewidth=1 ,zorder=0)
ax.set_xlabel(r'Wavelength, $\lambda$ [$\mathrm{\mu}$m]')
ax.set_ylabel(r'TOA flux, $F$ [W m$^{-2}$]')
ax.legend(frameon=True,loc='best')
sns.despine(fig=None, ax=None, top=True, right=True, left=False, bottom=False, offset=None, trim=False)
fig.savefig('Spectral_flux_TOA_SOCRATES.pdf',bbox_inches='tight')
pl.show()
#pl.close()

fig, ax = pl.subplots(figsize=(10,8))
ax.semilogx(Band_centers_soc,diffuse_spectral_up_surf, label="Diffuse up", linewidth=0.5 ,zorder=10)
ax.semilogx(Band_centers_soc,direct_spectral_up_surf, label="Direct up", linewidth=0.5 ,zorder=5)
ax.semilogx(Band_centers_soc,net_spectral_surf, label="Total net", linewidth=1 ,zorder=0)
ax.set_xlabel(r'Wavelength, $\lambda$ [$\mathrm{\mu}$m]')
ax.set_ylabel(r'Surface flux, $F$ [W m$^{-2}$]')
ax.legend(frameon=True,loc='best')
sns.despine(fig=None, ax=None, top=True, right=True, left=False, bottom=False, offset=None, trim=False)
fig.savefig('Spectral_flux_surf_SOCRATES.pdf',bbox_inches='tight')
pl.show()
#pl.close()

